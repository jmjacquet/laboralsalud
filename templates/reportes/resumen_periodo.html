{% extends "base.html" %}
{% load static from staticfiles %}
{% load i18n %}
{% load bootstrap3 %}
{% load humanize %}
{% block extra_js %}
<script src="{% static 'js/highcharts.js' %}" type="text/javascript"></script>
<script src="{% static 'js/exporting.js' %}" type="text/javascript"></script>
<script src="{% static 'js/canvg.js' %}" type="text/javascript"></script>

{% endblock extra_js %}
{% block breadcrumbs %}              
        <div class="breadcrumbs">
            Reporte Indicadores
        </div>
{% endblock breadcrumbs %}

{% block principal %}                            
<br>
    

<div class="col-md-12">   
   
 <div class="barra_busqueda" id="barra_busqueda">
  <div class="panel panel-primary">
      <div class="panel-heading">
                      PARÁMETROS DE BÚSQUEDA
      </div> 
      <div class="panel-body">
              <div class="col-md-12">
               <form class="form" accept-charset="UTF-8" autocomplete="off" role="form" action="" method="post">
                  {% csrf_token %} 
                  <div class="barra_busqueda col-sm-12">                                    
                          <div class="col-sm-1">{% bootstrap_field form.fdesde  %}</div>                                
                          <div class="col-sm-1">{% bootstrap_field form.fhasta  %}</div>                                    
                          <div class="col-sm-3">{% bootstrap_field form.empresa  %}</div>                                    
                          <div class="col-sm-2">{% bootstrap_field form.tipo_ausentismo  %}</div>                            
                          <div class="col-sm-2">{% bootstrap_field form.trab_cargo  %}</div>                            
                          <div class="col-sm-3">{% bootstrap_field form.empleado  %}</div>
                         
                          <div class="col-sm-12">
                            {% if ausentismos %} 
                            <button class="btn btn-xs btn-primary text-center pull-left" id="exportar" type="button">Exportar</button>
                            {% endif %}
                            <button class="btn btn-xs btn-primary text-center pull-right" type="submit">Buscar</button></div>
                          
                  </div>     
                          
              </div>
      </div>  
  </div>
  </div>
    </form> 
 {% if ausentismos %} 
  {% if aus_total or aus_inc %} 
  <div class="row">  
      
      <div class="col-sm-6 cerca">
          <div class="graficos panel panel-primary">
            <div  class="panel-heading text-center">AUSENTISMO TOTAL</div>
            <div class="panel-body">
              <div class="row">
                <div  class="col-sm-12">
                  <table  id="tabla_ausentismo_tot" class="table table-striped table-hover table-condensed table-no-bordered">
                    <tbody>
                      <tr>
                        <td  class="titulo" width="50%">Días caídos</td><td class="dato" width="50%">{{aus_total.dias_caidos_tot|default_if_none:0}}</td>
                      </tr>
                      <tr>
                        <td class="titulo">Cantidad de Empleados</td><td class="dato">{{aus_total.empleados_tot|default_if_none:0}}</td>                
                      </tr>
                      <tr>
                        <td  class="titulo">Días laborables del período</td><td class="dato">{{aus_total.dias_laborables|default_if_none:0}}</td>
                      </tr>
                      <tr>
                        <td class="titulo">Tasa de Ausentismo</td><td class="dato">{{aus_total.tasa_ausentismo|default_if_none:0}}%</td>                
                      </tr>
                      <tr>
                        <td class="titulo">Días trabajados</td><td class="dato">{{aus_total.dias_trab_tot|default_if_none:0}}</td>                
                      </tr>                  
                    </tbody>
                  </table>
                </div>
               </div>
               <div class="row">
                <div class="col-sm-12">
                     <div style="padding: 5px; position: relative;"> 
                                <div id="ausentismo_tot" class="chart" style="width: 90%; height: 100%; margin: 0 auto"></div>
                      </div>    
                </div>  
              </div>
                
            </div>
          </div>
          
      </div>           
      
      <div class="col-sm-6 cerca">
          <div class="panel panel-primary graficos">
            <div class="panel-heading text-center">AUSENTISMO INCULPABLE</div>
            <div class="panel-body">
              <div class="row">
                <div class="col-sm-12">
                  <table id="tabla_ausentismo_inc" class="table table-striped table-hover table-condensed table-no-bordered">
                    <tbody>
                      <tr>
                        <td  class="titulo" width="50%">Días caídos</td><td class="dato" width="50%">{{aus_inc.dias_caidos_tot|default_if_none:0}}</td>
                      </tr>
                      <tr>
                        <td class="titulo">Cantidad de Empleados</td><td class="dato">{{aus_inc.empleados_tot|default_if_none:0}}</td>                
                      </tr>
                      <tr>
                        <td  class="titulo">Días laborables del período</td><td class="dato">{{aus_inc.dias_laborables|default_if_none:0}}</td>
                      </tr>
                      <tr>
                        <td class="titulo">Tasa de Ausentismo</td><td class="dato">{{aus_inc.tasa_ausentismo|default_if_none:0}}%</td>                
                      </tr>
                      <tr>
                        <td class="titulo">Días trabajados</td><td class="dato">{{aus_inc.dias_trab_tot|default_if_none:0}}</td>                
                      </tr>                  
                      <tr>
                        <td class="titulo">AGUDOS (<=30)</td><td class="dato">{{aus_inc.porc_agudos|default_if_none:0}}%</td>                
                      </tr>
                      <tr>
                        <td class="titulo">CRÓNICOS (>30)</td><td class="dato">{{aus_inc.porc_cronicos|default_if_none:0}}%</td>                
                      </tr>     
                    </tbody>
                  </table>
                </div>
               </div>
               <div class="row">
                <div class="col-sm-12">
                     <div style="padding: 0px; position: relative;"> 
                                <div id="ausentismo_inc" class="chart" style="width: 100%; height: 100%; margin: 0 auto"></div>
                      </div>    
                </div>  
              </div>
                
            </div>
          </div>
          
      </div>
  </div>
  {% endif %}
  {% if aus_acc %}        
  <div class="row">
      <div class="col-sm-4 col-lg-4 cerca">
          <div class="panel panel-primary graficos">
            <div class="panel-heading text-center">AUSENTISMO ART</div>
            <div class="panel-body">
              <div class="row">
                <div class="col-sm-12">
                  <table id="tabla_ausentismo_acc" class="table table-striped table-hover table-condensed table-no-bordered">
                    <tbody>
                      <tr>
                        <td  class="titulo" width="50%">Días caídos</td><td class="dato" width="50%">{{aus_acc.dias_caidos_tot}}</td>
                      </tr>
                      <tr>
                        <td class="titulo">Cantidad de Empleados</td><td class="dato">{{aus_acc.empleados_tot}}</td>                
                      </tr>
                      <tr>
                        <td  class="titulo">Días laborables del período</td><td class="dato">{{aus_acc.dias_laborables}}</td>
                      </tr>
                      <tr>
                        <td class="titulo">Tasa de Ausentismo</td><td class="dato">{{aus_acc.tasa_ausentismo|default_if_none:0}}%</td>                
                      </tr>
                      <tr>
                        <td class="titulo">Días trabajados</td><td class="dato">{{aus_acc.dias_trab_tot}}</td>                
                      </tr>                  
                    </tbody>
                  </table>
                </div>
               </div>
               <div class="row">
                <div class="col-sm-12">
                     <div  style="padding: 0px; position: relative;"> 
                                <div id="ausentismo_acc" class="chart" style="width: 100%; height: 100%; margin: 0 auto"></div>
                      </div>    
                </div>  
              </div>
                
            </div>
          </div>
      </div>
      <div class="col-sm-4 col-lg-4 cerca">
          <div class="panel panel-primary graficos">
            <div class="panel-heading text-center">DENUNCIA DE ACCIDENTES</div>
            <div class="panel-body">              
               <div class="row">
                <div class="col-sm-12">
                     <div  style="padding: 0px; position: relative;"> 
                                <div id="ausentismo_acc2" class="chart" style="width: 100%; height: 100%; margin: 0 auto"></div>
                      </div>    
                </div>  
              </div>
                
            </div>
          </div>
      </div>     
          
       <div class="col-sm-4 col-lg-4 cerca">
          <div class="panel panel-primary graficos">
            <div class="panel-heading text-center">TIPO DE ACCIDENTES</div>
            <div class="panel-body">              
               <div class="row">
                <div class="col-sm-12">
                     <div  style="padding: 0px; position: relative;"> 
                                <div id="ausentismo_acc3" class="chart" style="width: 100%; height: 100%; margin: 0 auto"></div>
                      </div>    
                </div>  
              </div>
                
            </div>
          </div>
       </div> 
  </div>
  {% endif %}
  {% if aus_x_grupop %}   
  <div class="row">                         
      
      <div class="col-sm-8 cerca">
          <div class="panel panel-primary graficos">
            <div class="panel-heading text-center">AUSENTISMO x GRUPO PATOLÓGICO</div>
            <div class="panel-body">
               <div class="row">
                <div class="col-sm-12">
                     <div style="padding: 0px; position: relative;"> 
                                <div id="aus_grupop" class="chart" style="width: 100%; height: 100%; margin: 0 auto"></div>
                      </div>    
                </div>  
              </div>
                
            </div>
          </div>
          
      </div>
        <div class="col-sm-4 col-lg-4 cerca">
          <div class="graficos panel panel-primary">
            <div  class="panel-heading text-center">EMPLEADOS CON MÁS AUSENCIAS</div>
            <div class="panel-body">
              <div class="row">
                <div  class="col-sm-12">
                  <table  id="tabla_empleados" class="table table-striped table-hover table-no-bordered tabla_nueva text-nowrap">         
                    <thead >
                        <tr>
                            <th class="imprimir">Empleado</th>                            
                            <th class="imprimir">Días Caídos</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for e in empl_mas_faltadores %}
                        <tr>                                                            
                            <td title="{{ e.empleado|default_if_none:''}}"><a href="{% url 'empleado_detalles' id=e.empleado.id %}"  class="modal-detail" data-modal-head="DETALLE EMPLEADO {{e.empleado.legajo}}" data-modal-callback="reload"><strong>{{ e.empleado|default_if_none:''|truncatechars:60 }}</strong></a></td>                         
                            <td class="text-right">{{ e.dias|default_if_none:'0' }}</td>                    
                        </tr>
                        {% endfor %}
                    </tbody>
                    
                </table>
                </div>
               </div>                              
            </div>
          </div>
          
      </div>
          
  </div>
  {% endif %}
 {% endif %}         
</div>

<script src="{% static 'js/jspdf.debug.js' %}" type="text/javascript"></script>
<script src="{% static 'js/jspdf.plugin.autotable.js' %}"  type="text/javascript"></script>

<script type="text/javascript">
  
$(document).ready(function() {  
$.fn.datepicker.dates['es'] = {
    days: ["Domingo", "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado", "Domingo"],
    daysShort: ["Dom", "Lun", "Mar", "Mié", "Jue", "Vie", "Sáb", "Dom"],
    daysMin: ["Do", "Lu", "Ma", "Mi", "Ju", "Vi", "Sa", "Do"],
    months: ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"],
    monthsShort: ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"],
    today: "Hoy"
  };
  
 $('.datepicker').datepicker({
        format: "dd/mm/yyyy",
        language: "es",
        autoclose: true,
        todayHighlight: true
  });

  $('.datepicker').each(function(){
      $(this).datepicker();
  });


  $("#id_empresa").chosen({
      no_results_text: "Empresa inexistente...",
      placeholder_text_single:"Seleccione una Empresa",
      allow_single_deselect: true,
  });


  
});      
jQuery(document).ready(function($) {       
    Highcharts.setOptions({
      spacingBottom: 0,
      spacingTop: 0,
      spacingLeft: 0,
      spacingRight: 0,    
      //colors: ['red', 'blue', 'orange', 'yellow', 'purple', 'brown'],
      colors: [ '#DF5353','#6495ED','#64E572',  '#DDDF00', '#6A5ACD', '#FFF263','#ED561B','#FF9655', '#24CBE5'],
      chart: {
          plotBackgroundColor: null,
          plotBorderWidth: null,
          plotShadow: false,
          type: 'pie',
          height:300,
      },   
      tooltip: {
          pointFormat: '{series.name}: <b>{point.y:.2f}%</b>'
      },
      credits: {
                    enabled: false
                  },
      title: {
              text : null,
            },
      plotOptions: {
          pie: {            
              innerSize:'0%' ,
              allowPointSelect: true,
              cursor: 'pointer',
              dataLabels: {
                  enabled: false,
                  format: '<b>{point.name}</b>: {point.percentage:.2f}%',
                  style: {
                      color: (Highcharts.theme && Highcharts.theme.contrastTextColor) || 'black',
                      fontSize: "8px",
                  },
                  connectorColor: 'silver',                 
              },
              showInLegend: true
          }
      },
      navigation: {
              buttonOptions: {
                  enabled: false
              }
          },

    });
    {% if aus_total %}
    var h1 = Highcharts.chart('ausentismo_tot', {
        legend: {
            align: 'center',
            verticalAlign: 'bottom',
            layout: 'vertical',            
            labelFormat:'<b>{name}</b>: {percentage:.2f}% ({custom.empleados} empl.)',
        //     labelFormatter: function () {
        //     return this.name + ' (click to hide)';
        // }
        },
        series: [{
            name: 'AUSENTISMO TOTAL',
            data: [                
                    { name: 'Tasa Ausentismo', y: {{aus_total.tasa_ausentismo|safe}},custom:{empleados: {{aus_total.ta_cant_empls|safe}} }, },           
                    { name: 'Tasa Asistencia', y: {{aus_total.porc_dias_trab_tot|safe}},custom:{empleados: {{aus_total.tp_cant_empls|safe}} }, },                           
            ]
        }]
    });
     {% endif %}
    {% if aus_inc %}
    Highcharts.chart('ausentismo_inc', {
        legend: {
            align: 'center',
            verticalAlign: 'bottom',
            layout: 'vertical',
            labelFormat:'<b>{name}</b>: {percentage:.2f}% ({custom.empleados} empl.)',
        },
        series: [{
            type: 'pie',
            name: 'Días Caídos/Trabajados',
            // size: '90%',
            innerSize: '60%',
            data: [                
                    { name: 'Tasa Ausentismo', y: {{aus_inc.tasa_ausentismo|safe}},custom:{empleados: {{aus_inc.inc_cant_empls|safe}} },},           
                    { name: 'Tasa Asistencia', y: {{aus_inc.porc_dias_trab_tot|safe}},custom:{empleados: {{aus_inc.noinc_cant_empls|safe}}  },},                           
            ]            
        }, {
            type: 'pie',
            name: 'Tipo Ausentismo',
            size: '40%',
            innerSize: '50%',
            data: [{ name: 'Agudos',color:'#2ec363', y: {{aus_inc.porc_agudos|safe}},custom:{empleados: {{aus_inc.tot_agudos|safe}} },  },           
                    { name: 'Crónicos',color:'#DF5353', y: {{aus_inc.porc_cronicos|safe}},custom:{empleados: {{aus_inc.tot_cronicos|safe}} }, },  
            ]
        }]

    });
     {% endif %}
    {% if aus_acc %}
    Highcharts.chart('ausentismo_acc', {
        legend: {
            align: 'center',
            verticalAlign: 'bottom',
            layout: 'vertical',
            labelFormat:'<b>{name}</b>: {percentage:.2f}% ({custom.empleados} empl.)',
        },
        series: [{
            name: 'AUSENTISMO ACCIDENTES',
            data: [                
                    { name: 'Tasa Ausentismo', y: {{aus_acc.tasa_ausentismo|safe}},custom:{empleados: {{aus_acc.acc_empls|safe}} }  },           
                    { name: 'Tasa Asistencia', y: {{aus_acc.porc_dias_trab_tot|safe}} ,custom:{empleados: {{aus_acc.noacc_empls|safe}} } },                           
            ]
        }]
    });
    Highcharts.chart('ausentismo_acc2', {
        legend: {
            align: 'center',
            verticalAlign: 'bottom',
            layout: 'vertical',
            labelFormat:'<b>{name}</b>: {percentage:.2f}% ({custom.empleados} empl.)',
        },
        series: [{
            type: 'pie',
            name: 'Denuncias',
            data: [                
                    { name: 'Denunciados',color:'#6495ED', y: {{aus_acc.acc_denunciados|safe}},custom:{empleados: {{aus_acc.denunciados_empl|safe}} } },           
                    { name: 'No Denunciados',color:'#DF5353', y: {{aus_acc.acc_sin_denunciar|safe}},custom:{empleados: {{aus_acc.sin_denunciar_empl|safe}} }  },                           
            ]            
        },]

    });
     Highcharts.chart('ausentismo_acc3', {
        legend: {
            align: 'center',
            verticalAlign: 'bottom',
            layout: 'vertical',
            labelFormat:'<b>{name}</b>: {percentage:.2f}% ({custom.empleados} empl.)',
        },
        series: [{
            type: 'pie',
            name: 'Denuncias',
            data: [                
                    { name: 'In Itínere',color:'#DF5353', y: {{aus_acc.acc_itinere|safe}},custom:{empleados: {{aus_acc.itinere_empl|safe}} } },           
                    { name: 'En Ocasión de Trabajo',color:'#2ec363', y: {{aus_acc.acc_trabajo|safe}},custom:{empleados: {{aus_acc.trabajo_empl|safe}} }  },                           
            ]            
        },]

    });
    {% endif %}
    
    {% if aus_x_grupop %}
                   
        Highcharts.chart('aus_grupop', {
           
            chart: {
                plotBackgroundColor: null,
                plotBorderWidth: null,
                plotShadow: false,
                type: 'column',
                spacingBottom: 5,
                spacingTop: 10,
                spacingLeft: 0,
                spacingRight: 0, 
            },
            plotOptions: {
                series: {
                    dataLabels: {
                        enabled: true
                    }
                },
            },   
            xAxis: {
                categories: ['Patologías más Frecuentes'],
                crosshair: true
            },
            yAxis: {
               min: 0,
               max:{{max_grupop}},
               title: {
                  text: 'Cantidad de Casos'         
               }      
            },

            tooltip: {
                pointFormat: '<b>{point.y} casos</b>'
            },
            credits: {
                          enabled: false
                        },
            title: {
                    text : null,
                  },
            legend: {
            align: 'left',
            verticalAlign: 'middle',
            layout: 'vertical',
            labelFormat:'<b>{name}</b>',
            },
            
            series: [                                
                    {% for p in aus_x_grupop %}                
                        { name: '{{p.aus_grupop__patologia|safe}}', data: [{{p.total|safe}}],custom:{empleados: {{p.total|safe}}},                        
                    },           
                    {% endfor %}
                ],
           
        });
    
    
    {% endif %}

(function (H) {
    H.Chart.prototype.createCanvas = function (divId) {
        var svg = this.getSVG(),
            width = parseInt(svg.match(/width="([0-9]+)"/)[1]),
            height = parseInt(svg.match(/height="([0-9]+)"/)[1]),
            canvas = document.createElement('canvas');

        canvas.setAttribute('width', width);
        canvas.setAttribute('height', height);

        if (canvas.getContext && canvas.getContext('2d')) {

            canvg(canvas, svg);

            return canvas.toDataURL("image/jpeg");

        } 
        else {
            alert("Your browser doesn't support this feature, please use a modern browser");
            return false;
        }

    }
}(Highcharts));

function agregar_linea(texto,ltexto,htexto,h,idtabla,idgrafico,marginleft)
    {
    doc.text(texto,ltexto,h+htexto,'center');
    //doc.text("AUSENTISMOS TOTALES", 14, 33, null, null, "center");
    // doc.line(20,35,90, 35);    

    var table = doc.autoTable(
      {
        startY: h+3+htexto, 
        html: idtabla, 
        styles: {fontSize: 6,cellwidth: 'wrap',overflow: 'linebreak'},
        columnStyles: { 0: { halign: 'right' },2: { halign: 'right' } },
        tableWidth: 'wrap',
        tableLineWidth:0.5,   
        margin: {left: marginleft}
       }
    );            
    var imageData = $(idgrafico).highcharts().createCanvas();
    doc.addImage(imageData, 'JPEG', 105,h-7,chartWidth, chartHeight);
    //addImage(imagedata, type, x, y, width, height)
    //save with name
    };


    var doc = new jsPDF({orientation: 'p', unit: 'mm', format: 'a4',});

    var logo = new Image();
    logo.src  = "{% static 'img/logo.jpg' %}";
    var pagewidth = doc.internal.pageSize.width;
    var pageheight = doc.internal.pageSize.height;
    doc.addImage(logo, 'JPEG', 5,5,10, 10);
    

    doc.setFontSize(15);    
    doc.setFontType('bold');    
    doc.text('{{titulo_reporte}}', 110, 10, 'center');
    doc.setFontSize(10);  
    doc.text('{{filtro}}', 110, 15, 'center');
   
    //doc.text('REPORTE INDICADORES "{{empresa}}"',30,10);
    // chart height defined here so each chart can be palced
    // in a different position
    
    var chartHeight = 48;
    var chartWidth = 95;
    specialElementHandlers = {
            // element with id of "bypass" - jQuery style selector
            '#bypassme': function (element, renderer) {
                // true = "handled elsewhere, bypass text extraction"
                return true
            }
        };
    // All units are in the set measurement for the document
    // This can be changed to "pt" (points), "mm" (Default), "cm", "in"
    doc.setFontSize(10);    
    doc.setFontType('bold');    
    var altura = 30;
    {% if aus_total %}
      agregar_linea("AUSENTISMO TOTAL",58,0,altura,'#tabla_ausentismo_tot',"#ausentismo_tot",40);      
    {% endif %}
    {% if aus_inc %}
      altura=altura+chartHeight;
      agregar_linea("AUSENTISMO INCULPABLE",59,-5,altura,'#tabla_ausentismo_inc',"#ausentismo_inc",40);
    {% endif %}
    {% if aus_acc %}
      altura=altura+chartHeight;      
      agregar_linea("AUSENTISMO ART",58,0,altura+5,'#tabla_ausentismo_acc',"#ausentismo_acc",40);
      altura=altura+chartHeight+5;
      
      var imageData = $("#ausentismo_acc2").highcharts().createCanvas();
      doc.text('DENUNCIAS DE ACCIDENTES', 60, altura-2, 'center');
      doc.addImage(imageData, 'JPEG', 15,altura,chartWidth, chartHeight);

      var imageData = $("#ausentismo_acc3").highcharts().createCanvas();
      doc.text('TIPOS DE ACCIDENTES', 150, altura-2, 'center');
      doc.addImage(imageData, 'JPEG', 105,altura,chartWidth, chartHeight);

      // agregar_linea("DENUNCIA Y TIPO DE ACCIDENTE",65,10,altura+10,'#tabla_ausentismo_acc2',"#ausentismo_acc2",35);
    {% endif %}
     {% if aus_x_grupop %}
      altura=altura+chartHeight+10;
      var imageData = $("#aus_grupop").highcharts().createCanvas();      
      doc.text('AUSENTISMOS x GRUPO PATOLÓGICO', 150, altura-2, 'center');
      doc.addImage(imageData, 'JPEG', 100,altura,chartWidth, chartHeight);
      
      doc.text('EMPLEADOS CON MÁS AUSENCIAS',55, altura-2, 'center');
      var table2 = doc.autoTable(
      {
        startY: altura+2, 
        html:"#tabla_empleados" , 
        styles: {fontSize: 6,cellwidth: 'wrap',overflow: 'linebreak'},
        columnStyles: { 0: { halign: 'left' },1: { halign: 'right' } },
        tableWidth: 'wrap',
        tableLineWidth:0.5,   
        margin: {left: 30}
       });
     {% endif %}    
    
    doc.setFontSize(5);
    doc.setFontType('italic');            
    doc.text('{{pie_pagina}}', 15, 293);
    doc.addImage(logo, 'JPEG', 5,290,5, 5);
    $('#exportar').click(function () {
      doc.save('reporte_ausentismos.pdf');
        // doc.autoPrint();
    });



});



</script>

{% endblock principal %}





