{% extends "base.html" %}
{% load static from staticfiles %}
{% load i18n %}
{% load bootstrap3 %}
{% load humanize %}
{% block extra_js %}
<script src="{% static 'js/highcharts.js' %}" type="text/javascript"></script>
<script src="{% static 'js/exporting.js' %}" type="text/javascript"></script>
<script src="{% static 'js/canvg.js' %}" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.4/jspdf.min.js"></script>
{% endblock extra_js %}
{% block breadcrumbs %}              
        <div class="breadcrumbs">
            Reporte Indicadores
        </div>
{% endblock breadcrumbs %}

{% block principal %}                            
<br>
    

<div class="col-md-12">   
  
 <div class="barra_busqueda" id="barra_busqueda">
  <div class="panel panel-primary">
      <div class="panel-heading">
                      PARÁMETROS DE BÚSQUEDA
      </div> 
      <div class="panel-body">
              <div class="col-md-12">
               <form class="form" accept-charset="UTF-8" autocomplete="off" role="form" action="" method="post">
                  {% csrf_token %} 
                  <div class="barra_busqueda col-sm-12">                                    
                          <div class="col-sm-1">{% bootstrap_field form.fdesde  %}</div>                                
                          <div class="col-sm-1">{% bootstrap_field form.fhasta  %}</div>                                    
                          <div class="col-sm-3">{% bootstrap_field form.empresa  %}</div>                                    
                          <div class="col-sm-2">{% bootstrap_field form.tipo_ausentismo  %}</div>                            
                          <div class="col-sm-2">{% bootstrap_field form.trab_cargo  %}</div>                            
                          <div class="col-sm-3">{% bootstrap_field form.empleado  %}</div>
                         
                          <div class="col-sm-12">
                         
                            <button class="btn btn-xs btn-primary text-center pull-right" type="submit">Buscar</button></div>
                          
                  </div>     
                          
              </div>
      </div>  
  </div>
  </div>
    </form> 
  <button class="btn btn-xs btn-primary text-center pull-right" id="exportar" target="_blank">Exportar</button>
  <div class="row">  
      {% if aus_total %}
      <div class="col-sm-6">
          <div class="graficos panel panel-primary">
            <div  class="panel-heading text-center">AUSENTISMO TOTAL</div>
            <div class="panel-body">
              <div class="row">
                <div id="tabla_ausentismo_tot" class="col-sm-12">
                  <table  class="table table-striped table-hover table-condensed table-no-bordered">
                    <tbody>
                      <tr>
                        <td  class="titulo" width="50%">Días caídos</td><td class="dato" width="50%">{{aus_total.dias_caidos_tot|default_if_none:0}}</td>
                      </tr>
                      <tr>
                        <td class="titulo">Cantidad de Empleados</td><td class="dato">{{aus_total.empleados_tot|default_if_none:0}}</td>                
                      </tr>
                      <tr>
                        <td  class="titulo">Días laborables del período</td><td class="dato">{{aus_total.dias_laborables|default_if_none:0}}</td>
                      </tr>
                      <tr>
                        <td class="titulo">Tasa de Ausentismo</td><td class="dato">{{aus_total.tasa_ausentismo|default_if_none:0}}%</td>                
                      </tr>
                      <tr>
                        <td class="titulo">Días trabajados</td><td class="dato">{{aus_total.dias_trab_tot|default_if_none:0}}</td>                
                      </tr>                  
                    </tbody>
                  </table>
                </div>
               </div>
               <div class="row">
                <div class="col-sm-12">
                     <div style="padding: 0px; position: relative;"> 
                                <div id="ausentismo_tot" class="chart" style="width: 100%; height: 100%; margin: 0 auto"></div>
                      </div>    
                </div>  
              </div>
                
            </div>
          </div>
          
      </div>      
      {% endif %}

      {% if aus_inc %}
      <div class="col-sm-6">
          <div class="panel panel-primary graficos">
            <div class="panel-heading text-center">AUSENTISMO INCULPABLE</div>
            <div class="panel-body">
              <div class="row">
                <div class="col-sm-12">
                  <table class="table table-striped table-hover table-condensed table-no-bordered">
                    <tbody>
                      <tr>
                        <td  class="titulo" width="50%">Días caídos</td><td class="dato" width="50%">{{aus_inc.dias_caidos_tot|default_if_none:0}}</td>
                      </tr>
                      <tr>
                        <td class="titulo">Cantidad de Empleados</td><td class="dato">{{aus_inc.empleados_tot|default_if_none:0}}</td>                
                      </tr>
                      <tr>
                        <td  class="titulo">Días laborables del período</td><td class="dato">{{aus_inc.dias_laborables|default_if_none:0}}</td>
                      </tr>
                      <tr>
                        <td class="titulo">Tasa de Ausentismo</td><td class="dato">{{aus_inc.tasa_ausentismo|default_if_none:0}}%</td>                
                      </tr>
                      <tr>
                        <td class="titulo">Días trabajados</td><td class="dato">{{aus_inc.dias_trab_tot|default_if_none:0}}</td>                
                      </tr>                  
                      <tr>
                        <td class="titulo">AGUDOS (<=30)</td><td class="dato">{{aus_inc.porc_agudos|default_if_none:0}}%</td>                
                      </tr>
                      <tr>
                        <td class="titulo">CRÓNICOS (>30)</td><td class="dato">{{aus_inc.porc_cronicos|default_if_none:0}}%</td>                
                      </tr>     
                    </tbody>
                  </table>
                </div>
               </div>
               <div class="row">
                <div class="col-sm-12">
                     <div style="padding: 0px; position: relative;"> 
                                <div id="ausentismo_inc" class="chart" style="width: 100%; height: 100%; margin: 0 auto"></div>
                      </div>    
                </div>  
              </div>
                
            </div>
          </div>
          
      </div>
      {% endif %}                     
      {% if aus_acc %}
      <div class="col-sm-6">
          <div class="panel panel-primary graficos">
            <div class="panel-heading text-center">AUSENTISMO ART</div>
            <div class="panel-body">
              <div class="row">
                <div class="col-sm-12">
                  <table id="tabla_ausentismo_acc" class="table table-striped table-hover table-condensed table-no-bordered">
                    <tbody>
                      <tr>
                        <td  class="titulo" width="50%">Días caídos</td><td class="dato" width="50%">{{aus_acc.dias_caidos_tot}}</td>
                      </tr>
                      <tr>
                        <td class="titulo">Cantidad de Empleados</td><td class="dato">{{aus_acc.empleados_tot}}</td>                
                      </tr>
                      <tr>
                        <td  class="titulo">Días laborables del período</td><td class="dato">{{aus_acc.dias_laborables}}</td>
                      </tr>
                      <tr>
                        <td class="titulo">Tasa de Ausentismo</td><td class="dato">{{aus_acc.tasa_ausentismo|default_if_none:0}}%</td>                
                      </tr>
                      <tr>
                        <td class="titulo">Días trabajados</td><td class="dato">{{aus_acc.dias_trab_tot}}</td>                
                      </tr>                  
                    </tbody>
                  </table>
                </div>
               </div>
               <div class="row">
                <div class="col-sm-12">
                     <div  style="padding: 0px; position: relative;"> 
                                <div id="ausentismo_acc" class="chart" style="width: 100%; height: 100%; margin: 0 auto"></div>
                      </div>    
                </div>  
              </div>
                
            </div>
          </div>
          
      </div>
      <div class="col-sm-6">
          <div class="panel panel-primary graficos">
            <div class="panel-heading text-center">DENUNCIA Y TIPO DE ACCIDENTE</div>
            <div class="panel-body">
              <div class="row">
                <div class="col-sm-12">
                  <table class="table table-striped table-hover table-condensed table-no-bordered">
                    <tbody>                      
                      <tr>
                        <td class="titulo">Denunciados</td><td class="dato">{{aus_acc.acc_denunciados|default_if_none:0}}%</td>                
                        <td class="titulo">In Itínere</td><td class="dato">{{aus_acc.acc_itinere|default_if_none:0}}%</td>                
                      </tr>
                      <tr>
                        <td class="titulo">No Denunciados</td><td class="dato">{{aus_acc.acc_sin_denunciar|default_if_none:0}}%</td>                
                        <td class="titulo">En Ocasión de Trabajo</td><td class="dato">{{aus_acc.acc_trabajo|default_if_none:0}}%</td>                
                      </tr>
                      
                    </tbody>
                  </table>
                </div>
               </div>
               <div class="row">
                <div class="col-sm-12">
                     <div  style="padding: 0px; position: relative;"> 
                                <div id="ausentismo_acc2" class="chart" style="width: 100%; height: 100%; margin: 0 auto"></div>
                      </div>    
                </div>  
              </div>
                
            </div>
          </div>
          
      </div>
      {% endif %}                     
      {% if aus_x_grupop %}
      <div class="col-sm-6">
          <div class="panel panel-primary graficos">
            <div class="panel-heading text-center">AUSENTISMO x GRUPO PATOLÓGICO</div>
            <div class="panel-body">
               <div class="row">
                <div class="col-sm-12">
                     <div class="chart" style="padding: 0px; position: relative;"> 
                                <div id="aus_grupop" style="width: 100%; height: 100%; margin: 0 auto"></div>
                      </div>    
                </div>  
              </div>
                
            </div>
          </div>
          
      </div>
      {% endif %}          
  </div>
           
</div>



<script type="text/javascript">
  
$(document).ready(function() {  
$.fn.datepicker.dates['es'] = {
    days: ["Domingo", "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado", "Domingo"],
    daysShort: ["Dom", "Lun", "Mar", "Mié", "Jue", "Vie", "Sáb", "Dom"],
    daysMin: ["Do", "Lu", "Ma", "Mi", "Ju", "Vi", "Sa", "Do"],
    months: ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"],
    monthsShort: ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"],
    today: "Hoy"
  };
  
 $('.datepicker').datepicker({
        format: "dd/mm/yyyy",
        language: "es",
        autoclose: true,
        todayHighlight: true
  });

  $('.datepicker').each(function(){
      $(this).datepicker();
  });


  $("#id_empresa").chosen({
      no_results_text: "Empresa inexistente...",
      placeholder_text_single:"Seleccione una Empresa",
      allow_single_deselect: true,
  });


  
});      
jQuery(document).ready(function($) {       
    Highcharts.setOptions({
    spacingBottom: 0,
    spacingTop: 0,
    spacingLeft: 0,
    spacingRight: 0,    
    colors: [ '#f7a35c','#7798BF','#55BF3B','#7cb5ec','#90ee7e', '#7798BF', '#aaeeee', '#ff0066',
        '#eeaaee',  '#DF5353',  '#aaeeee'],
    chart: {
        plotBackgroundColor: null,
        plotBorderWidth: null,
        plotShadow: false,
        type: 'pie'
    },   
    tooltip: {
        pointFormat: '{series.name}: <b>{point.y:.2f}%</b>'
    },
    credits: {
                  enabled: false
                },
    title: {
            text : null,
          },
    plotOptions: {
        pie: {            
            innerSize:'50%' ,
            allowPointSelect: true,
            cursor: 'pointer',
            dataLabels: {
                enabled: false,
                format: '<b>{point.name}</b>: {point.percentage:.2f} %',
                style: {
                    color: (Highcharts.theme && Highcharts.theme.contrastTextColor) || 'black',
                    fontSize: "8px",
                },
                connectorColor: 'silver',                 
            },
            showInLegend: true
        }
    },
    navigation: {
            buttonOptions: {
                enabled: false
            }
        },

  });
    {% if aus_total %}
    var h1 = Highcharts.chart('ausentismo_tot', {
        legend: {
            labelFormat:'<b>{name}</b>: {percentage:.2f}%',
        },
        series: [{
            name: 'AUSENTISMO TOTAL',
            data: [                
                    { name: 'Tasa Ausentismo', y: {{aus_total.tasa_ausentismo|safe}},sliced: true,  selected: true  },           
                    { name: 'Tasa Asistencia', y: {{aus_total.porc_dias_trab_tot|safe}} },                           
            ]
        }]
    });
     {% endif %}
    {% if aus_inc %}
    Highcharts.chart('ausentismo_inc', {
        legend: {
            labelFormat:'<b>{name}</b>: {percentage:.2f}%',
        },
        series: [{
            type: 'pie',
            name: 'Días Caídos/Trabajados',
            size: '90%',
            innerSize: '60%',
            data: [                
                    { name: 'Tasa Ausentismo', y: {{aus_inc.tasa_ausentismo|safe}},sliced: true,  selected: true },           
                    { name: 'Tasa Asistencia', y: {{aus_inc.porc_dias_trab_tot|safe}} },                           
            ]            
        }, {
            type: 'pie',
            name: 'Tipo Ausentismo',
            size: '40%',
            innerSize: '50%',
            data: [{ name: 'Agudos',color:'#2ec363', y: {{aus_inc.porc_agudos|safe}}  },           
                    { name: 'Crónicos',color:'#DF5353', y: {{aus_inc.porc_cronicos|safe}} },  
            ]
        }]

    });
     {% endif %}
    {% if aus_acc %}
    Highcharts.chart('ausentismo_acc', {
        legend: {
            labelFormat:'<b>{name}</b>: {percentage:.2f}%',
        },
        series: [{
            name: 'AUSENTISMO ACCIDENTES',
            data: [                
                    { name: 'Tasa Ausentismo', y: {{aus_acc.tasa_ausentismo|safe}},sliced: true,  selected: true  },           
                    { name: 'Tasa Asistencia', y: {{aus_acc.porc_dias_trab_tot|safe}} },                           
            ]
        }]
    });
    Highcharts.chart('ausentismo_acc2', {
        legend: {
            labelFormat:'<b>{name}</b>: {percentage:.2f}%',
        },
        series: [{
            type: 'pie',
            name: 'Denuncias',
            size: '90%',
            innerSize: '60%',
            data: [                
                    { name: 'Denunciados', y: {{aus_acc.acc_denunciados|safe}},sliced: true,  selected: true },           
                    { name: 'No Denunciados', y: {{aus_acc.acc_sin_denunciar|safe}} },                           
            ]            
        }, {
            type: 'pie',
            name: 'Tipo Accidente',
            size: '40%',
            innerSize: '50%',
            data: [{ name: 'In Itínere',color:'#2ec363', y: {{aus_acc.acc_itinere|safe}}  },           
                    { name: 'En Ocasión de Trabajo',color:'#DF5353', y: {{aus_acc.acc_trabajo|safe}} },  
            ]
        }]

    });
    {% endif %}
    {% if aus_x_grupop %}
          colors: ['#04ff00','#147b50', '#ff0000', '#9c1918', '#DDDF00', '#24CBE5', '#64E572', '#FF9655', '#FFF263', '#6AF9C4'],
          Highcharts.setOptions({
          colors: Highcharts.map(Highcharts.getOptions().colors, function (color) {
              return {
                  radialGradient: {
                      cx: 0.5,
                      cy: 0.3,
                      r: 0.7
                  },
                  stops: [
                      [0, color],
                      [1, Highcharts.Color(color).brighten(-0.3).get('rgb')] // darken
                  ]
              };
          })
      });
      Highcharts.chart('aus_grupop', {
            
            chart: {
                plotBackgroundColor: null,
                plotBorderWidth: null,
                plotShadow: false,
                type: 'pie',
                spacingBottom: 5,
                spacingTop: 0,
                spacingLeft: 0,
                spacingRight: 0, 
            },   
          
            tooltip: {
                pointFormat: '<b>{point.percentage:.2f}% (cant:{point.y})</b>'
            },
            credits: {
                          enabled: false
                        },
            title: {
                    text : null,
                  },
            plotOptions: {
                pie: {
                    innerSize:'0%' ,
                    allowPointSelect: true,
                    cursor: 'pointer',
                    dataLabels: {            
                         enabled: true,
                         format: '<b>{point.name}</b>: {point.percentage:.2f} %',
                         style: {
                             color: (Highcharts.theme && Highcharts.theme.contrastTextColor) || 'black',
                             fontSize: "8px",
                         },
                         connectorColor: 'silver',                    
                    },
                    showInLegend:false,

                  }
                            
            },
            series: [{
                name: 'Grupo Patológico',
                data: [
                    {% for p in aus_x_grupop %}                
                        { name: '{{p.aus_grupop__patologia|safe}}', y: {{p.total|safe}}                        
                    },           
                    {% endfor %}
                ]
            }]
        });
    
    {% endif %}

(function (H) {
    H.Chart.prototype.createCanvas = function (divId) {
        var svg = this.getSVG(),
            width = parseInt(svg.match(/width="([0-9]+)"/)[1]),
            height = parseInt(svg.match(/height="([0-9]+)"/)[1]),
            canvas = document.createElement('canvas');

        canvas.setAttribute('width', width);
        canvas.setAttribute('height', height);

        if (canvas.getContext && canvas.getContext('2d')) {

            canvg(canvas, svg);

            return canvas.toDataURL("image/jpeg");

        } 
        else {
            alert("Your browser doesn't support this feature, please use a modern browser");
            return false;
        }

    }
}(Highcharts));

function agregar_tabla(divid,pdf,l,t,w) {
    
    // source can be HTML-formatted string, or a reference
    // to an actual DOM element from which the text will be scraped.
    htmlsource = $('#'+divid)[0];
    console.log(htmlsource);
    

    // we support special element handlers. Register them with jQuery-style 
    // ID selector for either ID or node name. ("#iAmID", "div", "span" etc.)
    // There is no support for any other type of selectors 
    // (class, of compound) at this time.
    specialElementHandlers = {
        // element with id of "bypass" - jQuery style selector
        '#bypassme': function (element, renderer) {
            // true = "handled elsewhere, bypass text extraction"
            return true
        }
    };
    margins = {
        top: t,        
        left: l,
        width: w
    };
    // all coords and widths are in jsPDF instance's declared units
    // 'inches' in this case
    pdf.fromHTML(
    htmlsource, // HTML string or DOM elem ref.
    margins.left, // x coord
    margins.top, { // y coord
        'width': margins.width, // max width of content on PDF
        'elementHandlers': specialElementHandlers
    },

    function (dispose) {

    }, margins);
}

$('#exportar').click(function () {
    var doc = new jsPDF();

    // chart height defined here so each chart can be palced
    // in a different position
    var chartHeight = 60;

    // All units are in the set measurement for the document
    // This can be changed to "pt" (points), "mm" (Default), "cm", "in"
    doc.setFontSize(20);
    doc.text(35, 20, "AUSENTISMOS");

    //loop through each chart
     doc.setFontSize(5);
    agregar_tabla("tabla_ausentismo_tot",doc,90,20,10);
    
    $('.chart').each(function (index) {
        var imageData = $(this).highcharts().createCanvas();

        // add image to doc, if you have lots of charts,
        // you will need to check if you have gone bigger 
        // than a page and do doc.addPage() before adding 
        // another image.

        /**
        * addImage(imagedata, type, x, y, width, height)
        */
        
        doc.addImage(imageData, 'JPEG', 5, (index * chartHeight) + 40, 80, chartHeight);
    });


    //save with name
    doc.save('demo.pdf');
});



});



</script>

{% endblock principal %}





